<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  Static code analysis using Go tools - Julien Limoges

    </title>
    <link rel="canonical" href="https://limoges.io/articles/using-golang-static-analysis/">
    <link rel="stylesheet" href="https://limoges.io/css/alpenfrisch.css">
  </head>
  <body>
    <div id="container">
      <header id="header">
        <nav class="navigation">  
    <a href="https://limoges.io/">Julien Limoges</a>
    
    <a href="https://limoges.io/articles/">Articles</a>
    
  </ul>
</nav>

      </header>
      <main id="content">
      <article>
    <header>
      <div class="date">
        <time class="published">August 23, 2017</time>
        
        <time class="edited">Edited on January 2, 2018</time>
        
      </div>
      <h1 class="title">Static code analysis using Go tools</h1>
      <p class="desc">A look at the kind of problems go&#39;s static analysis tool can detect in your code.</p>
    </header>
    <hr>
    

<h3 id="define-vet">define vet</h3>

<pre><code>vet | v…õt |
  verb (vets, vetting, vetted) [with object]
  - make a careful and critical examination of (something)
</code></pre>

<p>If you&rsquo;ve been using Go for a while you might have heard about <code>vet</code>.</p>

<p>Vet is a pretty interesting tool. For people familiar with <code>gcc</code> based tools, it
can be compared to the warnings <code>gcc</code> emits.</p>

<h1 id="invoking-vet">Invoking vet</h1>

<p>You can technically use <code>go vet</code>, but its interface is awkward for most.
It only works with packages names, which you can obtain through <code>go list</code>.</p>

<p>Instead you can use <code>go tool vet</code>. This version is simpler to work with, allowing
you to work with directories or files (as long as they are in a single package).
It you can also list the optional flags using <code>go tool vet --help</code>.</p>

<p>Here&rsquo;s a list of what the tool can do:</p>

<h2 id="locks-are-not-passed-by-value-copylocks-a-favourite">Locks are not passed by value (<code>-copylocks</code>) - A favourite.</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// Function with a mutex argument
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GoodLocker</span>(<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>) {}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BadLocker</span>(<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>) {} <span style="color:#75715e">// passes lock by value: sync.Mutex
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Struct with a mutex field
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Locker1</span> <span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">l</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Locker1</span>) <span style="color:#a6e22e">GoodMethod</span>() {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">Locker1</span>) <span style="color:#a6e22e">BadMethod</span>() {} <span style="color:#75715e">// passes lock by value: Locker1 contains sync.RWMutex
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
        <span style="color:#a6e22e">GoodLocker</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">l</span>)
        <span style="color:#a6e22e">BadLocker</span>(<span style="color:#a6e22e">l</span>) <span style="color:#75715e">// call of BadLocker copies lock value: sync.Mutex
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="useless-assignment-assign">Useless assignment (<code>-assign</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hey&#34;</span>
        <span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">s</span> <span style="color:#75715e">// self-assignment of s to s
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="mistaken-sync-atomic-usage-atomic">Mistaken sync/atomic usage (<code>-atomic</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> uint64(<span style="color:#ae81ff">0</span>)
        <span style="color:#a6e22e">n</span> = <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddUint64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">n</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// direct assignment to atomic value
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="mistakes-involving-boolean-operators-bool">Mistakes involving boolean operators (<code>-bool</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>
        <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">i</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>           <span style="color:#75715e">// suspect or: i != 10 || i != 2
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e">// redundant or: i == 1 || 1 == i
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="not-using-key-to-identify-struct-fields-composites">Not using key to identify struct fields (<code>-composites</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;container/list&#34;</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">Element</span>{
                <span style="color:#e6db74">&#34;First&#34;</span>, <span style="color:#75715e">// container/list.Element composite literal uses unkeyed fields
</span><span style="color:#75715e"></span>        }
        <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">Element</span>{
                <span style="color:#a6e22e">Value</span>: <span style="color:#e6db74">&#34;First&#34;</span>,
        }
}</code></pre></div>
<h2 id="nil-function-comparison-nilfunc">Nil function comparison (<code>-nilfunc</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">F</span>() {}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f</span> = <span style="color:#a6e22e">F</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> 
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">F</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// comparison of function F == nil is always false
</span><span style="color:#75715e"></span>
        }
}</code></pre></div>
<h2 id="printf-invocation-error-printf">Printf invocation error (<code>-printf</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#e6db74">&#34;hello&#34;</span>) <span style="color:#75715e">// arg &#34;hello&#34; for printf verb %d of wrong type: string
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="unsafe-concurrent-access-of-range-variables-rangeloops">Unsafe concurrent access of range variables (<code>-rangeloops</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
        <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">44</span>, <span style="color:#ae81ff">55</span>, <span style="color:#ae81ff">66</span>}
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span> {
                <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
                        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;bad %d\n&#34;</span>, <span style="color:#a6e22e">i</span>) <span style="color:#75715e">// range variable i captured by func literal
</span><span style="color:#75715e"></span>                }
        }
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span> {
                <span style="color:#75715e">// Correct usage
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
                        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;good %d\n&#34;</span>, <span style="color:#a6e22e">i</span>)
                }(<span style="color:#a6e22e">i</span>)
        }
}</code></pre></div>
<h2 id="variable-shadowing-shadow-not-active-by-default">Variable shadowing (<code>-shadow</code>). Not active by default</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">example</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>, <span style="color:#a6e22e">buf</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Len</span>() &gt; <span style="color:#ae81ff">0</span> {
                <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">ReadByte</span>()
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span> <span style="color:#75715e">// declaration of &#34;err&#34; shadows declaration...
</span><span style="color:#75715e"></span>                }
        }
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}</code></pre></div>
<h2 id="improper-usage-of-struct-field-tags-structtags">Improper usage of struct field tags (<code>-structtags</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Struct</span> <span style="color:#66d9ef">struct</span> {
        <span style="color:#a6e22e">A</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;a&#34;`</span>
        <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;a&#34;`</span> <span style="color:#75715e">// struct field B repeats json tag &#34;a&#34; also at...
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">C</span> <span style="color:#66d9ef">bool</span> <span style="color:#e6db74">`&#34;bad&#34;`</span>   <span style="color:#75715e">// sruct field tag `&#34;bad&#34;` not compatible with reflect.StructTag.Get:
</span><span style="color:#75715e"></span>                         <span style="color:#75715e">// bad syntax for struct tag key
</span><span style="color:#75715e"></span>}</code></pre></div>
<h2 id="unreachable-code-a-k-a-dead-code-unreachable">Unreachable code, A.K.A. dead code (<code>-unreachable</code>)</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">simpleMergeError</span>() <span style="color:#66d9ef">int</span> {
        <span style="color:#a6e22e">a</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;hello&#34;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unreachable&#34;</span>) <span style="color:#75715e">// unreachable code
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">anotherSimpleMergeError</span>(<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>) {
        <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">a</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span>:
                <span style="color:#66d9ef">return</span>
        <span style="color:#66d9ef">default</span>:
                <span style="color:#66d9ef">return</span>
        }
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unreachable&#34;</span>) <span style="color:#75715e">// unreachable code
</span><span style="color:#75715e"></span>}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">lessObviousCase</span>() {
        <span style="color:#66d9ef">for</span> {
                <span style="color:#66d9ef">for</span> {
                        <span style="color:#66d9ef">break</span>
                }
        }
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unreachable&#34;</span>) <span style="color:#75715e">// unreachable code
</span><span style="color:#75715e"></span>}</code></pre></div>
  </article>
      </main>
      <footer id="footer">
        
<p> Built with <a href="https://gohugo.io">Hugo</a> using my theme <a href="https://github.com/limoges/alpenfrisch">Alpenfrisch</a>.</p>


      </footer>
    </div>
  </body>
</html>
